-- Создание таблиц

CREATE TABLE IF NOT EXISTS PUBLIC."card_types" (
    "ID" INTEGER NOT NULL PRIMARY KEY,
    "name" VARCHAR
);

CREATE TABLE IF NOT EXISTS PUBLIC."type_of_catches" (
    "ID" INTEGER NOT NULL PRIMARY KEY,
    "name" VARCHAR
);

CREATE TABLE IF NOT EXISTS PUBLIC."status_labels" (
    "ID" INTEGER NOT NULL PRIMARY KEY,
    "name" VARCHAR
);

-- Нормализованная таблица пользователей (3NF)
CREATE TABLE IF NOT EXISTS PUBLIC."USERS" (
    "user_number" INTEGER NOT NULL PRIMARY KEY,
    "surname" VARCHAR,
    "name" VARCHAR,
    "patronymic" VARCHAR
);

-- Таблица контактов пользователей (устраняет транзитивные зависимости)
CREATE TABLE IF NOT EXISTS PUBLIC."USER_CONTACTS" (
    "contact_id" SERIAL PRIMARY KEY,
    "user_number" INTEGER NOT NULL REFERENCES PUBLIC."USERS"("user_number") ON DELETE CASCADE,
    "contact_type" VARCHAR(20) NOT NULL, -- 'phone', 'email'
    "contact_value" VARCHAR(200) NOT NULL,
    "is_primary" BOOLEAN DEFAULT FALSE,
    "created_date" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Основная таблица карточек
CREATE TABLE IF NOT EXISTS PUBLIC."SALE_CARD" (
    "unique_card_number" INTEGER NOT NULL PRIMARY KEY,
    "card_type" INTEGER NOT NULL REFERENCES "card_types",
    "type_of_catch" INTEGER  NOT NULL REFERENCES  "type_of_catches",
    "brends" VARCHAR,
    "date_" DATE,
    "status_label" INTEGER NOT NULL REFERENCES "status_labels",
    "user_number" INTEGER NOT NULL REFERENCES "USERS",
    "last_modified" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Таблица журнала учета
CREATE TABLE IF NOT EXISTS PUBLIC."ACCOUNTING_LOG" (
    "entry_number" INTEGER NOT NULL PRIMARY KEY,
    "date_of_capture" DATE,
    "return_date" DATE,
    "unique_card_number" INTEGER NOT NULL REFERENCES "SALE_CARD",
    "user_number" INTEGER NOT NULL REFERENCES "USERS"
);

-- Таблицы для соответствия 2NF и 3NF

-- История статусов карт
CREATE TABLE IF NOT EXISTS PUBLIC."CARD_STATUS_HISTORY" (
    "history_id" SERIAL PRIMARY KEY,
    "card_number" INTEGER NOT NULL REFERENCES PUBLIC."SALE_CARD"("unique_card_number"),
    "old_status" INTEGER REFERENCES PUBLIC."status_labels"("ID"),
    "new_status" INTEGER NOT NULL REFERENCES PUBLIC."status_labels"("ID"),
    "change_date" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "changed_by_user" INTEGER REFERENCES PUBLIC."USERS"("user_number"),
    "reason" TEXT
);

-- Метаданные карт
CREATE TABLE IF NOT EXISTS PUBLIC."CARD_METADATA" (
    "card_number" INTEGER PRIMARY KEY REFERENCES PUBLIC."SALE_CARD"("unique_card_number") ON DELETE CASCADE,
    "issue_date" DATE NOT NULL,
    "expiry_date" DATE,
    "last_used_date" DATE,
    "usage_count" INTEGER DEFAULT 0,
    "created_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Справочник причин изменения статусов (3NF)
CREATE TABLE IF NOT EXISTS PUBLIC."STATUS_CHANGE_REASONS" (
    "reason_id" SERIAL PRIMARY KEY,
    "reason_code" VARCHAR(50) NOT NULL UNIQUE,
    "reason_description" TEXT
);

-- Справочник операций аренды (3NF)
CREATE TABLE IF NOT EXISTS PUBLIC."RENTAL_OPERATION_TYPES" (
    "operation_type_id" SERIAL PRIMARY KEY,
    "type_name" VARCHAR(50) NOT NULL UNIQUE,
    "description" TEXT
);

-- Детали операций аренды (3NF)
CREATE TABLE IF NOT EXISTS PUBLIC."RENTAL_OPERATIONS" (
    "operation_id" SERIAL PRIMARY KEY,
    "log_entry" INTEGER NOT NULL REFERENCES PUBLIC."ACCOUNTING_LOG"("entry_number") ON DELETE CASCADE,
    "operation_type" INTEGER NOT NULL REFERENCES PUBLIC."RENTAL_OPERATION_TYPES"("operation_type_id"),
    "operation_date" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "performed_by" INTEGER REFERENCES PUBLIC."USERS"("user_number"),
    "notes" TEXT
);

-- Заполнение справочника типов карт
INSERT INTO public.card_types ("ID", name) VALUES
(1, 'A'),  
(2, 'B'),
(3, 'C');

-- Заполнение справочника статусов
INSERT INTO public.status_labels ("ID", name) VALUES
(1, 'Активна'), 
(2, 'Архивная'),
(3, 'Заблокирована'); 

-- Заполнение справочника типов уловов
INSERT INTO public.type_of_catches ("ID", name) VALUES
(1, 'a'), 
(2, 'b'), 
(3, 'c'); 

-- Заполнение таблицы пользователей (только основные данные)
INSERT INTO public."USERS" (user_number, surname, name, patronymic) VALUES
(1, 'Иванов', 'Иван', 'Иванович'),
(2, 'Петров', 'Петр', 'Петрович'),
(3, 'Сидорова', 'Мария', 'Сергеевна'),
(4, 'Кузнецов', 'Алексей', 'Владимирович');

-- Заполнение контактов пользователей (устранение транзитивных зависимостей)
INSERT INTO public."USER_CONTACTS" (user_number, contact_type, contact_value, is_primary) VALUES
(1, 'phone', '1234567', TRUE),
(1, 'email', 'ivanov@mail.ru', TRUE),
(2, 'phone', '7654321', TRUE),
(2, 'email', 'petrov@yandex.ru', TRUE),
(3, 'phone', '5554443', TRUE),
(3, 'email', 'sidorova@gmail.com', TRUE),
(4, 'phone', '8889990', TRUE),
(4, 'email', 'kuznetsov@mail.ru', TRUE);

-- Заполнение таблицы карточек (бренды остаются прежними)
INSERT INTO public."SALE_CARD" (unique_card_number, card_type, type_of_catch, brends, date_, status_label, user_number) VALUES
(1001, 1, 1, 'Adventure Gear', '2023-01-15', 1, 1),
(1002, 2, 2, 'Hunting Pro', '2023-02-20', 1, 2),
(1003, 3, 3, 'Multi Catch', '2023-03-10', 2, 3),
(1004, 1, 1, 'Fisherman Pride', '2023-04-05', 1, 4),
(1005, 2, 2, 'Wild Hunter', '2023-05-12', 3, 1);

-- Заполнение журнала учета
INSERT INTO public."ACCOUNTING_LOG" (entry_number, date_of_capture, return_date, unique_card_number, user_number) VALUES
(1, '2023-01-20', '2023-02-20', 1001, 1),
(2, '2023-02-25', '2023-03-25', 1002, 2),
(3, '2023-03-15', '2023-04-15', 1003, 3),
(4, '2023-04-10', '2023-05-10', 1004, 4),
(5, '2023-05-15', NULL, 1005, 1);

-- Заполнение таблицы метаданных карт
INSERT INTO PUBLIC."CARD_METADATA" ("card_number", "issue_date")
SELECT "unique_card_number", "date_" 
FROM PUBLIC."SALE_CARD";

-- Заполнение истории статусов на основе текущих данных
INSERT INTO PUBLIC."CARD_STATUS_HISTORY" ("card_number", "old_status", "new_status", "change_date")
SELECT "unique_card_number", NULL, "status_label", "date_"
FROM PUBLIC."SALE_CARD";

-- Заполнение справочника причин изменения статусов
INSERT INTO PUBLIC."STATUS_CHANGE_REASONS" ("reason_code", "reason_description") VALUES
('new_card', 'Создание новой карты'),
('user_request', 'Запрос пользователя'),
('automatic', 'Автоматическое изменение системой'),
('admin_action', 'Действие администратора'),
('expired', 'Истечение срока действия')
ON CONFLICT ("reason_code") DO NOTHING;

-- Заполнение справочника типов операций аренды
INSERT INTO PUBLIC."RENTAL_OPERATION_TYPES" ("type_name", "description") VALUES
('capture', 'Захват карты в аренду'),
('return', 'Возврат карты'),
('extend', 'Продление аренды'),
('cancel', 'Отмена аренды')
ON CONFLICT ("type_name") DO NOTHING;

-- Заполнение операций аренды
INSERT INTO PUBLIC."RENTAL_OPERATIONS" ("log_entry", "operation_type", "operation_date")
SELECT 
    "entry_number",
    (SELECT "operation_type_id" FROM PUBLIC."RENTAL_OPERATION_TYPES" WHERE "type_name" = 'capture'),
    "date_of_capture"
FROM PUBLIC."ACCOUNTING_LOG";

-- Добавление операций возврата
INSERT INTO PUBLIC."RENTAL_OPERATIONS" ("log_entry", "operation_type", "operation_date")
SELECT 
    "entry_number",
    (SELECT "operation_type_id" FROM PUBLIC."RENTAL_OPERATION_TYPES" WHERE "type_name" = 'return'),
    "return_date"
FROM PUBLIC."ACCOUNTING_LOG"
WHERE "return_date" IS NOT NULL;

-- Создание индексов для оптимизации запросов

-- Существующие индексы
CREATE INDEX IF NOT EXISTS "idx_card_status_history_card" 
ON PUBLIC."CARD_STATUS_HISTORY" ("card_number");

CREATE INDEX IF NOT EXISTS "idx_card_status_history_date" 
ON PUBLIC."CARD_STATUS_HISTORY" ("change_date");

CREATE INDEX IF NOT EXISTS "idx_card_metadata_number" 
ON PUBLIC."CARD_METADATA" ("card_number");

CREATE INDEX IF NOT EXISTS "idx_sale_card_status" 
ON PUBLIC."SALE_CARD" ("status_label");

CREATE INDEX IF NOT EXISTS "idx_sale_card_user" 
ON PUBLIC."SALE_CARD" ("user_number");

CREATE INDEX IF NOT EXISTS "idx_sale_card_type" 
ON PUBLIC."SALE_CARD" ("card_type");

CREATE INDEX IF NOT EXISTS "idx_accounting_log_dates" 
ON PUBLIC."ACCOUNTING_LOG" ("date_of_capture", "return_date");

CREATE INDEX IF NOT EXISTS "idx_accounting_log_card" 
ON PUBLIC."ACCOUNTING_LOG" ("unique_card_number");

CREATE INDEX IF NOT EXISTS "idx_accounting_log_user" 
ON PUBLIC."ACCOUNTING_LOG" ("user_number");

-- Новые индексы для 3NF таблиц
CREATE INDEX IF NOT EXISTS "idx_user_contacts_user" 
ON PUBLIC."USER_CONTACTS" ("user_number");

CREATE INDEX IF NOT EXISTS "idx_user_contacts_type" 
ON PUBLIC."USER_CONTACTS" ("contact_type");

CREATE INDEX IF NOT EXISTS "idx_rental_operations_log" 
ON PUBLIC."RENTAL_OPERATIONS" ("log_entry");

CREATE INDEX IF NOT EXISTS "idx_rental_operations_type" 
ON PUBLIC."RENTAL_OPERATIONS" ("operation_type");

CREATE INDEX IF NOT EXISTS "idx_rental_operations_date" 
ON PUBLIC."RENTAL_OPERATIONS" ("operation_date");

COMMIT;
